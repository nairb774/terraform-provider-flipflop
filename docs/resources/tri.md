---
# generated by https://github.com/hashicorp/terraform-plugin-docs
page_title: "flipflop_tri Resource - terraform-provider-flipflop"
subcategory: ""
description: |-
  Resource that allows tracking prior values with three states.
---

# flipflop_tri (Resource)

Resource that allows tracking prior values with three states.

## Example Usage

```terraform
# Django SECRET_KEY Rotation Example
#
# This example demonstrates using the tri-state flipflop to implement
# zero-downtime rotation of Django SECRET_KEY with fallback keys.
#
# Django supports SECRET_KEY_FALLBACKS for backward compatibility during rotation.
# The tri-state flipflop maintains three keys and rotates them gradually:
# - middle_index: The current active SECRET_KEY (second most recent)
# - top_index & bottom_index: The fallback keys (newest and oldest)
#
# This ensures that sessions/tokens signed with any of the three keys remain valid
# during the rotation period, providing forward-backward compatibility.

# Trigger rotation every 90 days
resource "time_rotating" "secret_key_rotation" {
  rotation_days = 90
}

# Encode configuration through the tri-state flipflop
resource "flipflop_tri" "secret_key" {
  value = jsonencode({
    trigger = time_rotating.secret_key_rotation.id
    length  = 50
  })
}

# Decode configurations for all three states
locals {
  secret_configs = [
    jsondecode(flipflop_tri.secret_key.a),
    jsondecode(flipflop_tri.secret_key.b),
    jsondecode(flipflop_tri.secret_key.c),
  ]
}

# Generate three secret keys
resource "random_password" "secret_keys" {
  count = length(local.secret_configs)

  length  = local.secret_configs[count.index].length
  special = false # Django SECRET_KEY typically uses alphanumeric only

  keepers = local.secret_configs[count.index]
}

# The middle key is the current active SECRET_KEY
output "django_secret_key" {
  value       = random_password.secret_keys[flipflop_tri.secret_key.middle_index].result
  sensitive   = true
  description = "Current active SECRET_KEY for Django settings"
}

# The top and bottom keys are the fallbacks
output "django_secret_key_fallbacks" {
  value = [
    random_password.secret_keys[flipflop_tri.secret_key.top_index].result,
    random_password.secret_keys[flipflop_tri.secret_key.bottom_index].result,
  ]
  sensitive   = true
  description = "SECRET_KEY_FALLBACKS list for Django settings"
}

# Example Django settings usage (as a comment for reference):
# SECRET_KEY = var.django_secret_key
# SECRET_KEY_FALLBACKS = var.django_secret_key_fallbacks
#
# During rotation:
# 1. New key is generated and becomes top_index
# 2. Previous active key (middle_index) remains the same
# 3. Oldest key (bottom_index) is still valid as a fallback
# 4. On next rotation, middle_index updates to the previous top_index
# 5. This ensures smooth rotation without invalidating sessions
```

<!-- schema generated by tfplugindocs -->
## Schema

### Required

- `value` (String) The current value.

### Read-Only

- `a` (String) One of the prior recorded values.
- `b` (String) One of the prior recorded values.
- `bottom_index` (Number) Index of the oldest value. Points to a (0), b (1), or c (2).
- `c` (String) One of the prior recorded values.
- `id` (String) Resource identifier.
- `middle_index` (Number) Index of the second most recent value. Points to a (0), b (1), or c (2).
- `top_index` (Number) Index of the most recent value. Points to a (0), b (1), or c (2).
